<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>대사 연습</title>

<style>

body {
  font-family: sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 0;
  text-align: center;
}

/* 배너 */
.banner img {
  width: 100%;
  height: 160px;
  object-fit: contain;
}

/* 입력칸 */
textarea {
  width: 90%;
  height: 200px;
  margin: 10px;
  font-size: 16px;
}

/* 역할 입력 */
input {
  font-size: 18px;
  padding: 10px;
  width: 200px;
  margin: 10px;
}

/* 버튼 기본 */
button {
  padding: 15px;
  font-size: 18px;
  margin: 5px;
  border: none;
  background: #ccc;
  cursor: pointer;
}

/* 연습시작 */
.startBtn {
  width: 90%;
  font-size: 24px;
}

/* 내대사보기 */
.myBtn {
  width: 90%;
}

/* 이전 다음 줄 */
.controlRow {
  display: flex;
  justify-content: center;
  gap: 10px;
}

.controlRow button {
  flex: 1;
  max-width: 200px;
}

/* 자동연습 */
.autoOn {
  background: green;
  color: white;
}

.autoOff {
  background: red;
  color: white;
}

/* 대사 출력 */
#dialogueBox {
  border: 1px solid black;
  margin: 20px;
  padding: 20px;
  min-height: 100px;
  background: white;
}

/* 게이지 */
#gageContainer {
  width: 90%;
  height: 20px;
  border: 1px solid black;
  margin: auto;
}

#gageBar {
  height: 100%;
  width: 100%;
  background: gold;
}

</style>
</head>

<body>

<!-- 배너 -->
<div class="banner">
<img src="banner.png">
</div>

<br>

<!-- 역할 -->
<div>
내 역할:
<input id="myRole" placeholder="예: 종대">
</div>

<!-- 음성 -->
<div>
음성:
<select id="gender">
<option value="male" selected>남자</option>
<option value="female">여자</option>
</select>

속도:
<input type="range" id="speed" min="0" max="5" step="0.1" value="2.5">
</div>

<br>

<!-- 대본 -->
<textarea id="script" placeholder=
"종대: 니 지금 뭐하는기고
영수: 아무것도 안했다
종대: 거짓말 하지마라">
</textarea>

<br>

<!-- 연습 시작 -->
<button class="startBtn" onclick="startPractice()">
연습 시작
</button>

<br>

<!-- 내 대사 -->
<button class="myBtn" onclick="showMyLine()">
내 대사 보기
</button>

<br>

<!-- 이전 다음 -->
<div class="controlRow">
<button onclick="prevLine()">이전</button>

<button id="autoBtn" class="autoOff" onclick="toggleAuto()">
자동연습 OFF
</button>

<button onclick="nextLine()">다음</button>
</div>

<!-- 대사 -->
<div id="dialogueBox">
&lt;상대 대사&gt;
</div>

<!-- 게이지 -->
<div id="gageContainer">
<div id="gageBar"></div>
</div>

<script>

let lines = [];
let index = 0;
let autoMode = false;
let timer;

let voices = [];

/* 음성 로딩 */
speechSynthesis.onvoiceschanged = function() {
  voices = speechSynthesis.getVoices();
};

/* 남자 여자 음성 */
function getKoreanVoice(gender) {

  let ko = voices.filter(v => v.lang.includes("ko"));

  if (gender === "male") {
    return ko.find(v =>
      v.name.includes("Male") ||
      v.name.includes("male") ||
      v.name.includes("Google 한국의 남성")
    ) || ko[0];
  } else {
    return ko.find(v =>
      v.name.includes("Female") ||
      v.name.includes("female")
    ) || ko[0];
  }
}

/* 말하기 */
function speak(text) {

  speechSynthesis.cancel();

  let utter = new SpeechSynthesisUtterance(text);

  let gender = document.getElementById("gender").value;
  let voice = getKoreanVoice(gender);

  if (voice) utter.voice = voice;

  let speed = document.getElementById("speed").value;
  utter.rate = speed / 2.5;

  speechSynthesis.speak(utter);
}

/* 시작 */
function startPractice() {

  let script = document.getElementById("script").value;
  lines = script.split("\n");

  index = 0;

  showLine();
}

/* 줄 표시 */
function showLine() {

  if (index < 0 || index >= lines.length) return;

  let myRole = document.getElementById("myRole").value;

  let line = lines[index];
  let parts = line.split(":");

  let role = parts[0];
  let text = parts[1];

  if (role !== myRole) {
    document.getElementById("dialogueBox").innerText = text;
    speak(text);

    if (autoMode) autoNext(text);
  } else {
    document.getElementById("dialogueBox").innerText = "(내 차례)";

    if (autoMode) autoNext(text);
  }
}

/* 자동 */
function autoNext(text) {

  let time = text.length * 200 + 2000;

  startGage(time);

  clearTimeout(timer);

  timer = setTimeout(() => {

    index++;

    if (index >= lines.length) {
      toggleAutoOff();
      return;
    }

    showLine();

  }, time);
}

/* 게이지 */
function startGage(time) {

  let bar = document.getElementById("gageBar");

  bar.style.width = "100%";

  let start = Date.now();

  let g = setInterval(() => {

    let now = Date.now();
    let diff = now - start;

    let percent = 100 - (diff/time)*100;

    bar.style.width = percent + "%";

    if (percent <= 0) clearInterval(g);

  }, 50);
}

/* 다음 */
function nextLine() {
  index++;
  showLine();
}

/* 이전 */
function prevLine() {
  index--;
  showLine();
}

/* 내 대사 */
function showMyLine() {

  let myRole = document.getElementById("myRole").value;

  let line = lines[index];
  let parts = line.split(":");

  if (parts[0] === myRole) {
    document.getElementById("dialogueBox").innerText = parts[1];
  }
}

/* 자동 ON OFF */
function toggleAuto() {

  autoMode = !autoMode;

  let btn = document.getElementById("autoBtn");

  if (autoMode) {
    btn.innerText = "자동연습 ON";
    btn.className = "autoOn";

    startPractice();
  } else {
    toggleAutoOff();
  }
}

function toggleAutoOff() {

  autoMode = false;

  let btn = document.getElementById("autoBtn");

  btn.innerText = "자동연습 OFF";
  btn.className = "autoOff";

  clearTimeout(timer);

  document.getElementById("gageBar").style.width = "100%";
}

</script>

</body>
</html>
