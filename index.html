<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>대본연습</title>

<style>

body{
    margin:0;
    background:#111;
    color:white;
    font-family:Arial;
}

.container{
    max-width:800px;
    margin:auto;
    padding:20px;
}

.banner{
    width:100%;
    margin-bottom:15px;
}

.scriptBox{
    background:black;
    border:1px solid #444;
    padding:25px;
    font-size:26px;
    min-height:120px;
    text-align:center;
}

.myLine{
    margin-top:10px;
    padding:20px;
    border:1px dashed #888;
    display:none;
    font-size:22px;
}

button{
    font-size:20px;
    padding:15px;
    margin-top:8px;
    width:100%;
    background:#333;
    color:white;
    border:none;
}

.bigBtn{
    font-size:28px;
    background:#d0a000;
    color:black;
}

textarea{
    width:100%;
    height:150px;
    margin-top:10px;
    background:black;
    color:white;
    border:1px solid #555;
}

input, select{
    width:100%;
    padding:12px;
    margin-top:8px;
    background:black;
    color:white;
    border:1px solid #555;
}

.counter{
    text-align:center;
    margin:10px;
}

</style>
</head>

<body>

<div class="container">

<img src="banner.png" class="banner">

<input id="myRole" placeholder="내 역할 이름">

<select id="voiceType">
<option value="auto">자동 음성</option>
<option value="female">여자 음성</option>
<option value="male">남자 음성</option>
</select>

<div class="counter" id="counter">
0번 연습
</div>

<textarea id="scriptInput"></textarea>

<div class="scriptBox" id="otherLine">
연습 시작
</div>

<div class="myLine" id="myLine"></div>

<button onclick="startPractice()">연습 시작</button>
<button onclick="showMyLine()">내 대사 보기</button>

<button class="bigBtn" onclick="prevLine()">◀ 이전</button>
<button class="bigBtn" onclick="nextLine()">다음 ▶</button>

<button onclick="saveScript()">대본 저장</button>
<button onclick="loadScript()">대본 불러오기</button>

<hr>

<button onclick="startRecording()">녹음 시작</button>
<button onclick="stopRecording()">녹음 정지</button>
<button onclick="playRecording()">녹음 재생</button>

<audio id="player" controls style="width:100%;margin-top:10px;"></audio>

</div>

<script>

let lines = [];
let index = -1;
let myRole = "";
let myLineText = "";
let repeatCount = 0;
let mediaRecorder;
let audioChunks = [];
let audioBlob;

function parseScript(){
    let text = document.getElementById("scriptInput").value;
    lines = text.split("\n");
}

function speak(text){

    speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);

    utter.rate = 0.9;
    utter.pitch = 1.0;
    utter.lang = "ko-KR";

    let voices = speechSynthesis.getVoices();
    let type = document.getElementById("voiceType").value;

    let selectedVoice;

    if(type === "female"){
        selectedVoice = voices.find(v => v.name.includes("Female"))
        || voices.find(v => v.name.includes("Siri"));
    }

    if(type === "male"){
        selectedVoice = voices.find(v => v.name.includes("Male"));
    }

    if(!selectedVoice){
        selectedVoice = voices.find(v => v.lang.includes("ko"));
    }

    if(selectedVoice){
        utter.voice = selectedVoice;
    }

    speechSynthesis.speak(utter);
}

function startPractice(){

    parseScript();

    myRole = document.getElementById("myRole").value.trim();

    if(myRole === ""){
        alert("역할 입력");
        return;
    }

    repeatCount++;
    document.getElementById("counter").innerText =
        repeatCount + "번 연습";

    index = -1;

    nextLine();
}

function nextLine(){

    document.getElementById("myLine").style.display="none";

    for(let i=0;i<lines.length;i++){

        index++;

        if(index >= lines.length){
            index = 0;
        }

        let line = lines[index];

        if(!line.includes(":")) continue;

        let role = line.split(":")[0].trim();
        let text = line.split(":")[1].trim();

        if(role === myRole){
            myLineText = text;
            continue;
        }

        document.getElementById("otherLine").innerText = text;

        speak(text);

        return;
    }
}

function prevLine(){

    document.getElementById("myLine").style.display="none";

    for(let i=0;i<lines.length;i++){

        index--;

        if(index < 0){
            index = lines.length-1;
        }

        let line = lines[index];

        if(!line.includes(":")) continue;

        let role = line.split(":")[0].trim();
        let text = line.split(":")[1].trim();

        if(role === myRole){
            myLineText = text;
            continue;
        }

        document.getElementById("otherLine").innerText = text;

        speak(text);

        return;
    }
}

function showMyLine(){

    if(myLineText === "") return;

    let box = document.getElementById("myLine");

    box.innerText = myLineText;
    box.style.display="block";
}

function saveScript(){

    localStorage.setItem(
        "script",
        document.getElementById("scriptInput").value
    );

    alert("저장됨");
}

function loadScript(){

    let saved = localStorage.getItem("script");

    if(saved){
        document.getElementById("scriptInput").value = saved;
    }
}

async function startRecording(){

    let stream = await navigator.mediaDevices.getUserMedia({audio:true});

    mediaRecorder = new MediaRecorder(stream);

    audioChunks = [];

    mediaRecorder.ondataavailable = e=>{
        audioChunks.push(e.data);
    }

    mediaRecorder.onstop = ()=>{
        audioBlob = new Blob(audioChunks);
        document.getElementById("player").src =
            URL.createObjectURL(audioBlob);
    }

    mediaRecorder.start();
}

function stopRecording(){
    mediaRecorder.stop();
}

function playRecording(){

    let player = document.getElementById("player");

    if(player.src){
        player.play();
    }
}

window.onload = function(){
    loadScript();
}

</script>

</body>
</html>
