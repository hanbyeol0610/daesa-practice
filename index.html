<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ëŒ€ë³¸ì—°ìŠµ</title>

<style>

body{
    margin:0;
    background:#1a1a1a;
    color:#eee;
    font-family:Arial;
}

.container{
    max-width:800px;
    margin:auto;
    padding:15px;
}

.banner{
    width:100%;
    margin-bottom:15px;
}

.scriptBox{
    background:#111;
    border:1px solid #555;
    padding:25px;
    font-size:24px;
    min-height:100px;
    text-align:center;
}

.myLine{
    margin-top:10px;
    padding:15px;
    border:1px dashed #999;
    display:none;
    font-size:20px;
}

button{
    font-size:18px;
    padding:12px;
    margin-top:6px;
    width:100%;
    background:#333;
    color:white;
    border:none;
}

.bigBtn{
    font-size:26px;
    background:#d4af37;
    color:black;
}

input, textarea, select{
    width:100%;
    padding:10px;
    margin-top:6px;
    background:#111;
    color:white;
    border:1px solid #555;
}

.counter{
    text-align:center;
    margin:10px;
}

.recRow{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top:10px;
}

.recBtn{
    width:40px;
    height:40px;
    font-size:18px;
}

</style>
</head>

<body>

<div class="container">

<img src="banner.png" class="banner">

<input id="myRole" placeholder="ë‚´ ì—­í•  ì´ë¦„">

<select id="voiceType">
<option value="auto">ìë™ ìŒì„±</option>
<option value="female">ì—¬ì</option>
<option value="male">ë‚¨ì</option>
</select>

<div class="counter" id="counter">
0ë²ˆ ì—°ìŠµ
</div>

<textarea id="scriptInput"></textarea>

<div class="scriptBox" id="otherLine">
ì—°ìŠµ ì‹œì‘
</div>

<div class="myLine" id="myLine"></div>

<button onclick="startPractice()">ì—°ìŠµ ì‹œì‘</button>
<button onclick="showMyLine()">ë‚´ ëŒ€ì‚¬ ë³´ê¸°</button>

<button class="bigBtn" onclick="prevLine()">â—€ ì´ì „</button>
<button class="bigBtn" onclick="nextLine()">ë‹¤ìŒ â–¶</button>

<div class="recRow">
<button class="recBtn" onclick="startRecording()">ğŸ™</button>
<button class="recBtn" onclick="stopRecording()">â– </button>
<button class="recBtn" onclick="playRecording()">â–¶</button>
</div>

<audio id="player"></audio>

</div>

<script>

let lines = [];
let index = -1;
let myRole = "";
let currentMyLine = "";
let repeatCount = 0;
let mediaRecorder;
let audioChunks = [];
let audioBlob;

function parseScript(){
    let text = document.getElementById("scriptInput").value;
    lines = text.split("\n");
}

function speak(text){

    speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "ko-KR";
    utter.rate = 0.95;
    utter.pitch = 1;

    let voices = speechSynthesis.getVoices();
    let type = document.getElementById("voiceType").value;

    let selectedVoice;

    if(type==="female"){
        selectedVoice = voices.find(v=>v.name.includes("Female"))
        || voices.find(v=>v.name.includes("Siri"));
    }

    if(type==="male"){
        selectedVoice = voices.find(v=>v.name.includes("Male"));
    }

    if(!selectedVoice){
        selectedVoice = voices.find(v=>v.lang.includes("ko"));
    }

    if(selectedVoice){
        utter.voice = selectedVoice;
    }

    speechSynthesis.speak(utter);
}

function startPractice(){

    parseScript();

    myRole = document.getElementById("myRole").value.trim();

    if(myRole===""){
        alert("ì—­í•  ì…ë ¥");
        return;
    }

    repeatCount++;
    document.getElementById("counter").innerText =
        repeatCount+"ë²ˆ ì—°ìŠµ";

    index=-1;

    nextLine();
}

function nextLine(){

    document.getElementById("myLine").style.display="none";

    while(true){

        index++;

        if(index>=lines.length){
            index=0;
        }

        let line = lines[index];

        if(!line.includes(":")) continue;

        let role = line.split(":")[0].trim();
        let text = line.split(":")[1].trim();

        if(role===myRole){
            currentMyLine=text;
            continue;
        }

        document.getElementById("otherLine").innerText=text;

        speak(text);

        return;
    }
}

function prevLine(){

    document.getElementById("myLine").style.display="none";

    while(true){

        index--;

        if(index<0){
            index=lines.length-1;
        }

        let line = lines[index];

        if(!line.includes(":")) continue;

        let role = line.split(":")[0].trim();
        let text = line.split(":")[1].trim();

        if(role===myRole){
            currentMyLine=text;
            continue;
        }

        document.getElementById("otherLine").innerText=text;

        speak(text);

        return;
    }
}

function showMyLine(){

    if(currentMyLine==="") return;

    let box=document.getElementById("myLine");

    box.innerText=currentMyLine;
    box.style.display="block";
}

async function startRecording(){

    let stream = await navigator.mediaDevices.getUserMedia({audio:true});

    mediaRecorder = new MediaRecorder(stream);

    audioChunks=[];

    mediaRecorder.ondataavailable=e=>{
        audioChunks.push(e.data);
    }

    mediaRecorder.onstop=()=>{
        audioBlob=new Blob(audioChunks);
        document.getElementById("player").src=
            URL.createObjectURL(audioBlob);
    }

    mediaRecorder.start();
}

function stopRecording(){
    if(mediaRecorder) mediaRecorder.stop();
}

function playRecording(){
    let player=document.getElementById("player");
    if(player.src) player.play();
}

</script>

</body>
</html>
