<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ëŒ€ë³¸ì—°ìŠµ</title>

<style>

body{
    margin:0;
    background:#1b1b1b;
    color:#eee;
    font-family:Arial;
}

.container{
    max-width:800px;
    margin:auto;
    padding:15px;
}

.banner{
    width:100%;
    margin-bottom:15px;
}

input, textarea, select{
    width:100%;
    padding:12px;
    margin-top:8px;
    background:#111;
    color:white;
    border:1px solid #555;
    font-size:16px;
}

textarea{
    height:300px;
}

.scriptBox{
    background:#111;
    border:1px solid #666;
    padding:20px;
    font-size:22px;
    min-height:60px;
    text-align:center;
}

.myLine{
    margin-top:10px;
    padding:15px;
    border:1px dashed #aaa;
    display:none;
    font-size:20px;
}

button{
    font-size:18px;
    padding:12px;
    margin-top:6px;
    width:100%;
    background:#333;
    color:white;
    border:none;
}

.bigBtn{
    font-size:26px;
    background:#d4af37;
    color:black;
}

.counter{
    text-align:center;
    margin:10px;
}

.iconRow{
    display:flex;
    gap:8px;
    justify-content:center;
    margin-top:10px;
}

.iconBtn{
    width:40px;
    height:40px;
    font-size:18px;
}

</style>
</head>

<body>

<div class="container">

<img src="banner.png" class="banner">

<input id="myRole" placeholder="ë‚´ ì—­í•  (ì˜ˆ: ì¢…ëŒ€)">

<select id="voiceType">
<option value="auto">ìë™ ìŒì„±</option>
<option value="female">ì—¬ìí†¤</option>
<option value="male">ë‚¨ìí†¤</option>
</select>

<select id="speed">
<option value="0.8">ëŠë¦¼</option>
<option value="0.95" selected>ë³´í†µ</option>
<option value="1.1">ë¹ ë¦„</option>
</select>

<div class="counter" id="counter">
0ë²ˆ ì—°ìŠµ
</div>

<textarea id="scriptInput">
ì¢…ëŒ€: í˜•ë‹˜ ì™œ ê·¸ëŸ¬ì‹­ë‹ˆê¹Œ
íŒìˆ˜: ë„Œ ë¹ ì ¸
ì¢…ëŒ€: ì´ë²ˆì—” ë‹¤ë¦…ë‹ˆë‹¤
íŒìˆ˜: ì¡°ìš©íˆ í•´
</textarea>

<div class="scriptBox" id="otherLine">
&lt;ìƒëŒ€ ëŒ€ì‚¬&gt;
</div>

<div class="myLine" id="myLine"></div>

<button onclick="startPractice()">ì—°ìŠµ ì‹œì‘</button>
<button onclick="showMyLine()">ë‚´ ëŒ€ì‚¬ ë³´ê¸°</button>

<button class="bigBtn" onclick="prevLine()">â—€ ì´ì „</button>
<button class="bigBtn" onclick="nextLine()">ë‹¤ìŒ â–¶</button>

<div class="iconRow">
<button class="iconBtn" onclick="saveScript()">ğŸ’¾</button>
<button class="iconBtn" onclick="loadScript()">ğŸ“‚</button>
<button class="iconBtn" onclick="startRecording()">ğŸ™</button>
<button class="iconBtn" onclick="stopRecording()">â– </button>
<button class="iconBtn" onclick="playRecording()">â–¶</button>
</div>

<audio id="player"></audio>

</div>

<script>

let lines = [];
let index = -1;
let myRole = "";
let currentMyLine = "";
let repeatCount = 0;
let mediaRecorder;
let audioChunks = [];
let audioBlob;

function parseScript(){
    let text = document.getElementById("scriptInput").value;
    lines = text.split("\n");
}

function speak(text){

    speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);

    utter.lang = "ko-KR";

    // ì†ë„
    utter.rate = parseFloat(
        document.getElementById("speed").value
    );

    // ë°°ìš°í†¤ ëŠë‚Œ
    utter.pitch = 0.9;

    let voices = speechSynthesis.getVoices();
    let type = document.getElementById("voiceType").value;

    let voice;

    if(type==="female"){
        voice = voices.find(v =>
            v.name.includes("Female") ||
            v.name.includes("Siri")
        );
    }

    if(type==="male"){
        voice = voices.find(v =>
            v.name.includes("Male")
        );
    }

    if(!voice){
        voice = voices.find(v =>
            v.lang.includes("ko")
        );
    }

    if(voice){
        utter.voice = voice;
    }

    speechSynthesis.speak(utter);
}

function startPractice(){

    parseScript();

    myRole = document.getElementById("myRole").value.trim();

    if(myRole===""){
        alert("ì—­í•  ì…ë ¥");
        return;
    }

    repeatCount++;
    document.getElementById("counter").innerText =
        repeatCount+"ë²ˆ ì—°ìŠµ";

    index=-1;
    nextLine();
}

function nextLine(){

    document.getElementById("myLine").style.display="none";

    let nextMyLine="";

    while(true){

        index++;

        if(index>=lines.length){
            index=0;
        }

        let line = lines[index];

        if(!line.includes(":")) continue;

        let role = line.split(":")[0].trim();
        let text = line.split(":")[1].trim();

        if(role===myRole){
            nextMyLine=text;
            continue;
        }

        currentMyLine = nextMyLine;

        document.getElementById("otherLine").innerText=text;

        speak(text);

        return;
    }
}

function prevLine(){

    document.getElementById("myLine").style.display="none";

    let prevMyLine="";

    while(true){

        index--;

        if(index<0){
            index=lines.length-1;
        }

        let line = lines[index];

        if(!line.includes(":")) continue;

        let role = line.split(":")[0].trim();
        let text = line.split(":")[1].trim();

        if(role===myRole){
            prevMyLine=text;
            continue;
        }

        currentMyLine = prevMyLine;

        document.getElementById("otherLine").innerText=text;

        speak(text);

        return;
    }
}

function showMyLine(){

    if(currentMyLine==="") return;

    let box=document.getElementById("myLine");

    box.innerText=currentMyLine;
    box.style.display="block";
}

function saveScript(){

    localStorage.setItem("script",
        document.getElementById("scriptInput").value);

    localStorage.setItem("role",
        document.getElementById("myRole").value);

    alert("ì €ì¥ë¨");
}

function loadScript(){

    document.getElementById("scriptInput").value =
        localStorage.getItem("script") || "";

    document.getElementById("myRole").value =
        localStorage.getItem("role") || "";
}

async function startRecording(){

    let stream = await navigator.mediaDevices.getUserMedia({audio:true});

    mediaRecorder = new MediaRecorder(stream);

    audioChunks=[];

    mediaRecorder.ondataavailable=e=>{
        audioChunks.push(e.data);
    }

    mediaRecorder.onstop=()=>{
        audioBlob=new Blob(audioChunks);
        document.getElementById("player").src=
            URL.createObjectURL(audioBlob);
    }

    mediaRecorder.start();
}

function stopRecording(){
    if(mediaRecorder) mediaRecorder.stop();
}

function playRecording(){
    let player=document.getElementById("player");
    if(player.src) player.play();
}

</script>

</body>
</html>
