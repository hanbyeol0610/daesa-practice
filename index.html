<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ëŒ€ë³¸ì—°ìŠµ</title>

<style>

body{
    margin:0;
    background:#181818;
    color:#eee;
    font-family:Arial;
}

.container{
    max-width:800px;
    margin:auto;
    padding:15px;
}

.banner{
    width:100%;
    margin-bottom:15px;
}

/* ì—­í•  */
.roleBox{
    background:#fff;
    color:#000;
    border:2px solid #c9a646;
    font-size:18px;
    padding:10px;
}

/* ëŒ€ë³¸ */
.scriptInput{
    background:#fff;
    color:#000;
    border:2px solid #c9a646;
    font-family:monospace;
    font-size:18px;
    line-height:1.8;
    padding:10px;
    width:100%;
    height:320px;
}

/* ìƒëŒ€ ëŒ€ì‚¬ */
.scriptBox{
    background:#111;
    border:1px solid #666;
    padding:20px;
    font-size:24px;
    min-height:80px;
    text-align:center;
    margin-top:10px;
}

/* HPë°” */
.hpContainer{
    width:100%;
    height:14px;
    background:#333;
    margin-top:5px;
}

.hpBar{
    height:100%;
    width:100%;
    background:#4caf50;
}

/* ë‚´ ëŒ€ì‚¬ */
.myLine{
    margin-top:10px;
    padding:15px;
    border:1px dashed #aaa;
    display:none;
    font-size:20px;
    background:#222;
}

button{
    font-size:18px;
    padding:12px;
    margin-top:6px;
    width:100%;
    background:#333;
    color:white;
    border:none;
}

.bigBtn{
    font-size:26px;
    background:#d4af37;
    color:black;
}

.row{
    display:flex;
    gap:10px;
}

.autoOn{
    background:#2e7d32;
}

.autoOff{
    background:#444;
}

.iconRow{
    display:flex;
    gap:8px;
    justify-content:center;
    margin-top:10px;
}

.iconBtn{
    width:40px;
    height:40px;
    font-size:18px;
}

</style>
</head>

<body>

<div class="container">

<img src="banner.png" class="banner">

<input id="myRole" class="roleBox" placeholder="ë‚´ ì—­í•  ì…ë ¥">

<br>

ì†ë„:
<input type="range" id="speed" min="0.1" max="2" step="0.1" value="1">
<span id="speedVal">1.0</span>

<textarea id="scriptInput" class="scriptInput">
ì¢…ëŒ€: í˜•ë‹˜ ì™œ ê·¸ëŸ¬ì‹­ë‹ˆê¹Œ
íŒìˆ˜: ë„Œ ë¹ ì ¸
ì¢…ëŒ€: ì´ë²ˆì—” ë‹¤ë¦…ë‹ˆë‹¤
íŒìˆ˜: ì¡°ìš©íˆ í•´
</textarea>

<div class="scriptBox" id="otherLine">
&lt;ìƒëŒ€ ëŒ€ì‚¬&gt;
</div>

<div class="hpContainer">
<div class="hpBar" id="hpBar"></div>
</div>

<div class="myLine" id="myLine"></div>

<button onclick="startPractice()">ì—°ìŠµ ì‹œì‘</button>
<button onclick="showMyLine()">ë‚´ ëŒ€ì‚¬ ë³´ê¸°</button>

<div class="row">
<button class="bigBtn" onclick="prevLine()">â—€ ì´ì „</button>
<button class="bigBtn" onclick="nextLine()">ë‹¤ìŒ â–¶</button>
</div>

<button id="autoBtn" class="autoOff" onclick="toggleAuto()">
ìë™ ì—°ìŠµ OFF
</button>

<div class="iconRow">
<button class="iconBtn" onclick="saveScript()">ğŸ’¾</button>
<button class="iconBtn" onclick="loadScript()">ğŸ“‚</button>
<button class="iconBtn" onclick="startRecording()">ğŸ™</button>
<button class="iconBtn" onclick="stopRecording()">â– </button>
<button class="iconBtn" onclick="playRecording()">â–¶</button>
</div>

<audio id="player"></audio>

</div>

<script>

let lines=[];
let index=-1;
let myRole="";
let currentMyLine="";
let autoMode=false;
let autoTimeout;
let mediaRecorder;
let audioChunks=[];

/* ì†ë„ í‘œì‹œ */
speed.oninput=function(){
    speedVal.innerText=this.value;
}

/* íŒŒì‹± */
function parseScript(){
    lines=scriptInput.value.split("\n");
}

/* ìŒì„± */
function speak(text){

    speechSynthesis.cancel();

    let utter=new SpeechSynthesisUtterance(text);
    utter.lang="ko-KR";
    utter.rate=parseFloat(speed.value);
    utter.pitch=0.9;

    speechSynthesis.speak(utter);

    return estimateTime(text);
}

/* ì½ëŠ” ì‹œê°„ */
function estimateTime(text){
    return (text.length*0.11)+2;
}

/* HPë°” */
function startHP(duration){

    let bar=hpBar;
    let start=Date.now();

    function frame(){

        let t=(Date.now()-start)/1000;
        let p=Math.max(0,1-(t/duration));

        bar.style.width=(p*100)+"%";

        if(p>0 && autoMode){
            requestAnimationFrame(frame);
        }
    }

    frame();
}

/* ë‹¤ìŒ */
function nextLine(){

    myLine.style.display="none";

    let found=false;

    for(let i=0;i<lines.length*2;i++){

        index++;
        if(index>=lines.length) index=0;

        let line=lines[index];
        if(!line.includes(":")) continue;

        let role=line.split(":")[0].trim();
        let text=line.split(":")[1].trim();

        if(role!==myRole && !found){

            otherLine.innerText=text;

            let time=speak(text);

            if(autoMode){
                startHP(time);
                autoTimeout=setTimeout(nextLine,time*1000);
            }

            found=true;
            continue;
        }

        if(found && role===myRole){
            currentMyLine=text;
            return;
        }
    }
}

/* ì‹œì‘ */
function startPractice(){

    parseScript();
    myRole=myRoleInput.value.trim();

    index=-1;
    nextLine();
}

/* ìë™ */
function toggleAuto(){

    autoMode=!autoMode;

    if(autoMode){
        autoBtn.innerText="ìë™ ì—°ìŠµ ON";
        autoBtn.className="autoOn";
        startPractice();
    }else{
        autoBtn.innerText="ìë™ ì—°ìŠµ OFF";
        autoBtn.className="autoOff";
        clearTimeout(autoTimeout);
        hpBar.style.width="100%";
    }
}

/* ë‚´ ëŒ€ì‚¬ */
function showMyLine(){
    myLine.innerText=currentMyLine;
    myLine.style.display="block";
}

/* ì €ì¥ */
function saveScript(){
    localStorage.setItem("script",scriptInput.value);
    localStorage.setItem("role",myRoleInput.value);
}

/* ë¶ˆëŸ¬ì˜¤ê¸° */
function loadScript(){
    scriptInput.value=localStorage.getItem("script")||"";
    myRoleInput.value=localStorage.getItem("role")||"";
}

/* ë…¹ìŒ */
async function startRecording(){
    let stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
        player.src=URL.createObjectURL(new Blob(audioChunks));
    }
    mediaRecorder.start();
}

function stopRecording(){
    mediaRecorder.stop();
}

function playRecording(){
    player.play();
}

</script>

</body>
</html>
