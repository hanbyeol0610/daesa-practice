<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ëŒ€ë³¸ì—°ìŠµ</title>

<style>

body{
    margin:0;
    background:#181818;
    color:#eee;
    font-family:Arial;
}

.container{
    max-width:800px;
    margin:auto;
    padding:15px;
}

.banner{
    width:100%;
    margin-bottom:15px;
}

/* ì˜í™” ìŠ¤í¬ë¦½íŠ¸ ëŠë‚Œ */
.roleBox{
    background:#0f0f0f;
    border:2px solid #c9a646;
    font-size:18px;
    letter-spacing:2px;
    padding:12px;
    width:100%;
}

.scriptInput{
    background:#0f0f0f;
    border:2px solid #c9a646;
    font-family:monospace;
    font-size:18px;
    line-height:1.8;
    padding:12px;
    width:100%;
    height:300px;
    margin-top:10px;
}

/* ìƒëŒ€ ëŒ€ì‚¬ */
.scriptBox{
    background:#111;
    border:1px solid #666;
    padding:20px;
    font-size:24px;
    min-height:80px;
    text-align:center;
    margin-top:10px;
}

/* HP ê²Œì´ì§€ */
.hpContainer{
    width:100%;
    height:14px;
    background:#333;
    margin-top:5px;
}

.hpBar{
    height:100%;
    width:100%;
    background:#4caf50;
    transition:width 0.1s linear;
}

.myLine{
    margin-top:10px;
    padding:15px;
    border:1px dashed #aaa;
    display:none;
    font-size:20px;
}

button{
    font-size:18px;
    padding:12px;
    margin-top:6px;
    width:100%;
    background:#333;
    color:white;
    border:none;
}

.bigBtn{
    font-size:26px;
    background:#d4af37;
    color:black;
}

.counter{
    text-align:center;
    margin:10px;
}

.iconRow{
    display:flex;
    gap:8px;
    justify-content:center;
    margin-top:10px;
}

.iconBtn{
    width:40px;
    height:40px;
    font-size:18px;
}

.row{
    display:flex;
    gap:10px;
}

.autoBtn{
    background:#2e7d32;
}

</style>
</head>

<body>

<div class="container">

<img src="banner.png" class="banner">

<input id="myRole" class="roleBox" placeholder="CASTING ROLE">

<select id="speed">
<option value="0.8">ëŠë¦¼</option>
<option value="0.95" selected>ë³´í†µ</option>
<option value="1.1">ë¹ ë¦„</option>
</select>

<div class="counter" id="counter">
0ë²ˆ ì—°ìŠµ
</div>

<textarea id="scriptInput" class="scriptInput">
ì¢…ëŒ€: í˜•ë‹˜ ì™œ ê·¸ëŸ¬ì‹­ë‹ˆê¹Œ
íŒìˆ˜: ë„Œ ë¹ ì ¸
ì¢…ëŒ€: ì´ë²ˆì—” ë‹¤ë¦…ë‹ˆë‹¤
íŒìˆ˜: ì¡°ìš©íˆ í•´
</textarea>

<div class="scriptBox" id="otherLine">
&lt;ìƒëŒ€ ëŒ€ì‚¬&gt;
</div>

<div class="hpContainer">
<div class="hpBar" id="hpBar"></div>
</div>

<div class="myLine" id="myLine"></div>

<button onclick="startPractice()">ì—°ìŠµ ì‹œì‘</button>
<button onclick="showMyLine()">ë‚´ ëŒ€ì‚¬ ë³´ê¸°</button>

<div class="row">
<button class="bigBtn" onclick="prevLine()">â—€ ì´ì „</button>
<button class="bigBtn" onclick="nextLine()">ë‹¤ìŒ â–¶</button>
</div>

<button class="autoBtn" onclick="toggleAuto()">
ìë™ ì—°ìŠµ
</button>

<div class="iconRow">
<button class="iconBtn" onclick="saveScript()">ğŸ’¾</button>
<button class="iconBtn" onclick="loadScript()">ğŸ“‚</button>
<button class="iconBtn" onclick="startRecording()">ğŸ™</button>
<button class="iconBtn" onclick="stopRecording()">â– </button>
<button class="iconBtn" onclick="playRecording()">â–¶</button>
</div>

<audio id="player"></audio>

</div>

<script>

let lines = [];
let index = -1;
let myRole = "";
let currentMyLine = "";
let repeatCount = 0;
let autoMode = false;
let autoTimer;
let mediaRecorder;
let audioChunks = [];

function parseScript(){
    lines = document.getElementById("scriptInput").value.split("\n");
}

function speak(text){

    speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);

    utter.lang="ko-KR";
    utter.rate=parseFloat(document.getElementById("speed").value);
    utter.pitch=0.9;

    speechSynthesis.speak(utter);

    return estimateTime(text);
}

/* ì½ëŠ” ì‹œê°„ ê³„ì‚° */
function estimateTime(text){
    let chars = text.length;
    return (chars * 0.12) + 2;
}

/* HPë°” */
function startHP(duration){

    let bar = document.getElementById("hpBar");
    let start = Date.now();

    function update(){

        let elapsed = (Date.now()-start)/1000;
        let remain = Math.max(0, duration-elapsed);
        let percent = (remain/duration)*100;

        bar.style.width = percent+"%";

        if(remain>0){
            requestAnimationFrame(update);
        }else{
            if(autoMode){
                nextLine();
            }
        }
    }

    update();
}

function startPractice(){

    parseScript();
    myRole=document.getElementById("myRole").value.trim();

    if(myRole===""){
        alert("ì—­í•  ì…ë ¥");
        return;
    }

    repeatCount++;
    document.getElementById("counter").innerText=
        repeatCount+"ë²ˆ ì—°ìŠµ";

    index=-1;
    nextLine();
}

function nextLine(){

    document.getElementById("myLine").style.display="none";

    let foundOther=false;

    for(let i=0;i<lines.length*2;i++){

        index++;
        if(index>=lines.length) index=0;

        let line=lines[index];
        if(!line.includes(":")) continue;

        let role=line.split(":")[0].trim();
        let text=line.split(":")[1].trim();

        if(role!==myRole && !foundOther){

            document.getElementById("otherLine").innerText=text;

            let time=speak(text);

            if(autoMode){
                startHP(time);
            }

            foundOther=true;
            continue;
        }

        if(foundOther && role===myRole){
            currentMyLine=text;
            return;
        }
    }
}

function prevLine(){
    index-=2;
    if(index<0) index=0;
    nextLine();
}

function showMyLine(){

    let box=document.getElementById("myLine");

    box.innerText=currentMyLine || "(ë‚´ ëŒ€ì‚¬ ì—†ìŒ)";
    box.style.display="block";
}

function toggleAuto(){

    autoMode=!autoMode;

    if(!autoMode){
        document.getElementById("hpBar").style.width="0%";
    }
}

function saveScript(){
    localStorage.setItem("script",
        document.getElementById("scriptInput").value);
    localStorage.setItem("role",
        document.getElementById("myRole").value);
}

function loadScript(){
    document.getElementById("scriptInput").value=
        localStorage.getItem("script")||"";
    document.getElementById("myRole").value=
        localStorage.getItem("role")||"";
}

/* ë…¹ìŒ */
async function startRecording(){
    let stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
        let blob=new Blob(audioChunks);
        player.src=URL.createObjectURL(blob);
    }
    mediaRecorder.start();
}

function stopRecording(){
    mediaRecorder.stop();
}

function playRecording(){
    player.play();
}

</script>

</body>
</html>
